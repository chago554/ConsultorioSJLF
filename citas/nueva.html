<script>

    $(function () {

        $('#campoFecha').val(new Date(new Date().getTime() - 6 * 60 * 60 * 1000).toISOString().slice(0, 16));

        cargarPacientes();
        cargarMedicos();
        obtenerFechaHoraISO();
    });

    //poner una fecha minima
    function obtenerFechaHoraISO() {
        var fecha = new Date(new Date().getTime() - 6 * 60 * 60 * 1000).toISOString().slice(0, 16);
        $("#campoFecha").attr('min', fecha);
    }

    //cargar pacientes
    function cargarPacientes() {
        $.ajax({
            url: backend + "/pacientesSJLF/listarSJLF",
            type: 'post',
            datatype: 'json',
            xhrFields: { withCredentials: true },

            success: function (respuesta) {
                console.log(respuesta);
                comboPaciente(respuesta);
            }
        });
    }

    //combo pacientes
    function comboPaciente(lista) {
        var combo = '<select class="form-select" id="comboPaciente">'
        $.each(lista, function (i, paciente) {
            combo += '<option value=' + paciente.id + ' >' + paciente.nombreSJLF + '( ' + paciente.curpSJLF + ')' + '</option>';
        });
        combo += '</select>';
        $("#divComboPaciente").html(combo);
    }

    //listar medicos
    function cargarMedicos() {
        $.ajax({
            url: backend + "/medicosSJLF/listarSJLF",
            type: 'post',
            datatype: 'json',
            xhrFields: { withCredentials: true },

            success: function (respuesta) {
                console.log(respuesta);
                comboMedicos(respuesta);
            }
        });
    }

    //combo medicos
    function comboMedicos(lista) {
        var combo = '<select class="form-select" id="comboMedico">'
        $.each(lista, function (i, medico) {
            combo += '<option value=' + medico.id + ' >' + medico.nombreSJLF + ' ' + medico.apellidosSJLF + '</option>';
        });
        combo += '</select>';
        $("#divComboMedicos").html(combo);
    }

    //guadar cita
    function guardarCita(idCita) {
        var datos = {
            nuevaFechaSJLF: $("#campoFecha").val(),
            paciente: {
                id: $("#comboPaciente").val()
            },
            medico: {
                id: $("#comboMedico").val()
            },

        }

        $.ajax({
            url: backend + "/citasSJLF/guadarSJLF",
            type: 'post',
            datatype: 'json',
            data: JSON.stringify(datos),
            contentType: 'application/json',
            xhrFields: { withCredentials: true },

            success: function (respuesta) {
                console.log(respuesta);
                $("#nuevaCitaModal").modal("hide");

                if (respuesta == '¡Cita creada exitosamente!') {
                    $.gritter.add({
                        title: "¡Listo!",
                        text: respuesta,
                        sticky: false,
                        image: 'correcto.png'
                    });

                    cargarCitas();
                } else {
                    $.gritter.add({
                        title: "¡Ups, Error!",
                        text: respuesta,
                        sticky: false,
                        image: 'cancelar.png'
                    })
                }
            }
        });
    }

    //filtrar paciente
    function buscarPacientes(texto) { //el texto de la caja de texto

        if (texto != '') {
            $.ajax({
                url: backend + "/pacientesSJLF/filtrarPacienteSJLF",
                type: 'post',
                datatype: 'json',
                data: texto,
                contentType: 'application/json',

                success: function (respuesta) {

                    if (respuesta != '') {
                        console.log(respuesta);
                        comboPaciente(respuesta);
                        $("#nuevoPaciente").addClass("d-none");

                    } else {
                        $("#nuevoPaciente").removeClass("d-none");
                        comboPaciente(respuesta);
                    }
                }
            });
        }
        else {
            cargarPacientes();
        }
    }

</script>
<form>
    <fieldset>
        <div>
            <label for="buscarPaciente" class="form-label mt-4"><i class="bi bi-search"></i> Datos del paciente:
            </label>
            <input type="text" class="form-control" id="buscarPaciente" placeholder="Buscar... "
                onkeyup="buscarPacientes(this.value)">
        </div>


        <div id="nuevoPaciente" data-bs-dismiss="modal" class="d-none row justify-content-center ps-2 pe-2">
            <button class="btn btn-success" type="button"
                onclick="$( '#divPrincipal').load('Pacientes/nuevo.html ')">Nuevo paciente</button>
        </div>

        <div>
            <label for="comboPaciente" class="form-label mt-4">Paciente: </label>
            <div id="divComboPaciente"></div>
        </div>
        <div>
            <label for="comboMedicos" class="form-label mt-4">Medico: </label>
            <div id="divComboMedicos"></div>
        </div>
        <div>
            <label for="comboFecha" class="form-label mt-4">Fecha: </label>
            <input type="datetime-local" class="date form-control" id="campoFecha">
        </div>
    </fieldset>
</form>