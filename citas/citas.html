<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script>

    $(function () {
        cargarCitas();
    });

    function cargarCitas() {
        $.ajax({
            url: backend + "/citasSJLF/listarSJLF",
            type: 'post',
            datatype: 'json',
            xhrFields: { withCredentials: true },

            success: function (respuesta) {
                console.log(respuesta);
                mostrarCitas(respuesta);
            }
        });
    }

    //   <!-- Es para mostrar los datos de mi BD en las tablas-->
    function mostrarCitas(lista) {
        var body = '';
        $.each(lista, function (i, citas) {
            var contador = contador + 1;
            body += '<tr class=" table-' + ((i % 2 == 0) ? 'success' : 'light') + '">' +
                '<td scope="row">' + citas.paciente.nombreSJLF + '<br>(' + citas.medico.nombreSJLF + " " + citas.medico.apellidosSJLF + ') </td>' +
                '<td scope="row" class="col d-flex">' + comboEstatusCitas(citas) + ' <div id="alertaEstatus' + citas.id + '"> </div>  </td>' +
                '<td scope="row" class="col"> <input type="datetime-local"  class="date form-control" value="' + citas.fechaHTML + '" onchange="cambiarFecha(' + citas.id + ',this.value, this);"><div id="alertaCitas' + citas.id + '"> </div>  </td> ' +
                '<td scope="row d-flex"> <button type="button" class="btn btnmodificar btn-info" onclick="modificarTarea(' + citas.id + ');"><i class="bi bi-pencil-square"></i></button> <button type="button" class=" btn btn-danger btnelimina" onclick="eliminar(' + citas.id + ');"> <i class="bi bi-trash3-fill"></i>   </button>   </td>' +
                '</tr>';
        });
        $('#tablaCitas > tbody').html(body);
    }

    //funcion para poner los combos de los estado de las citas
    function comboEstatusCitas(citas) {
        var combo = '<select class="form-select" onchange="cambiarEstatus(' + citas.id + ',this.value, this);">'
        $.each(citas.estatusCita, function (i, ecita) {
            combo += '<option value="' + ecita + '" ' + (citas.estatus == ecita ? 'selected' : '') + ' >' + ecita + '</option>';
        });
        combo += '</select>';
        return combo;
    }

    // Cambiar estatus
    function cambiarEstatus(idCita, nuevoEstatus, elemento) {
        var datos = {
            id: idCita,
            estatus: nuevoEstatus
        };

        $.ajax({
            url: backend + "/citasSJLF/cambiarEstatusSJLF",
            type: 'post',
            datatype: 'json',
            data: JSON.stringify(datos),
            contentType: 'application/json',
            xhrFields: { withCredentials: true },

            success: function (respuesta) {

                $(elemento).removeClass("is-invalid");

                $.gritter.add({
                    title: respuesta,
                    text: respuesta,    
                    sticky: false,
                    image: 'correcto.png'
                });

                setTimeout(function () {
                    $(elemento).addClass("is-valid");
                }, 100);

                setTimeout(function () {
                    $(elemento).removeClass("is-valid");
                }, 1000);
            },

            error: function () {
                $(elemento).addClass("is-invalid");
            }
        });
    }
    //cambiar fecha
    function cambiarFecha(idCita, nuevaFecha, elemento) {

        if(nuevaFecha!= ''){

        var donde = "#alertaCitas" + idCita;
        var datos = {
            id: idCita,
            nuevaFechaSJLF: nuevaFecha
        }
        $.ajax({
            url: backend + "/citasSJLF/cambiarFechaSJLF ",
            type: 'post',
            datatype: 'json',
            data: JSON.stringify(datos),
            contentType: 'application/json',
            xhrFields: { withCredentials: true },

            success: function (respuesta) {

                $(elemento).removeClass("is-invalid");

                $.gritter.add({
                    title: respuesta,
                    text: respuesta,
                    sticky: false,
                    image: 'correcto.png'
                });

                setTimeout(function () {
                    $(elemento).addClass("is-valid");
                }, 100);

                setTimeout(function () {
                    $(elemento).removeClass("is-valid");
                }, 1000);
            },

            error: function () {
                $(elemento).addClass("is-invalid");
            }


        });
    }else{
        $(elemento).addClass("is-invalid");
    }
}

</script>


<!-- label de bienvenida -->
<div class="row">
    <div class="col m-5 text-dark">
        <h1 class="fw-bold text-center text-uppercase text-dark ">Hola, bienvenido a tu
            gestor de citas</h1>
    </div>
</div>

<div id="divMensajesCitas" class="text-center fw-bold "></div>

<table class="table table-hover " id="tablaCitas">
    <thead class=" align-items-center">
        <tr class="table-dark ">
            <th scope="col" class="align-middle">Paciente / MÃ©dico</th>
            <th scope="col" class="align-middle">Estatus</th>
            <th scope="col" class="align-middle ">Fecha</th>
            <th scope="col" class="align-middle"><button type="button" data-bs-toggle="modal"
                    data-bs-target="#nuevaCitaModal" onclick=' $("#divNuevaCita").load("citas/nueva.html");'
                    class="btn btn-success align-middle">Agendar cita <i class="bi bi-plus-circle"></i> </button></th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

<!-- Modal -->
<div class="modal fade" id="nuevaCitaModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Nueva cita</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="divNuevaCita">
                ...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarCita();">Agendar cita</button>


            </div>
        </div>
    </div>
</div>