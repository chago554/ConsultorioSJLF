<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script>

    $(function () {
        cargarCitas();
    });

    function cargarCitas() {
        $.ajax({
            url: backend + "/citasSJLF/listarSJLF",
            type: 'post',
            datatype: 'json',
            xhrFields: { withCredentials: true },

            success: function (respuesta) {
                console.log(respuesta);
                mostrarCitas(respuesta);
            }
        });
    }

    //   <!-- Es para mostrar los datos de mi BD en las tablas-->
    function mostrarCitas(lista) {
        var body = '';
        $.each(lista, function (i, citas) {
            var contador = contador + 1;
            body += '<tr class=" table-' + ((i % 2 == 0) ? 'success' : 'light') + '">' +
                '<td scope="row">' + citas.paciente.nombreSJLF + '<br>(' + citas.medico.nombreSJLF + " " + citas.medico.apellidosSJLF + ') </td>' +
                '<td scope="row" class="col d-flex">' + comboEstatusCitas(citas) + ' <div id="alertaEstatus' + citas.id + '"> </div>  </td>' +
                '<td scope="row" class="col"> <input type="datetime-local" class="date form-control"  value="' + citas.fechaHTML + '" onchange="cambiarFecha(' + citas.id + ',this.value, this);"><div id="alertaCitas' + citas.id + '"> </div>  </td> ' +
                '<td scope="row d-flex"> <button type="button" class="btn btnmodificar btn-info" onclick="modificarCita(' + citas.id + ', this.value);"  data-bs-toggle="modal" data-bs-target="#modificarCitaModal"><i class="bi bi-pencil-square"></i></button> <button type="button" class=" btn btn-danger btnelimina" onclick="eliminarCita(' + citas.id + ');"> <i class="bi bi-trash3-fill"></i>   </button>  <div id="divBotonSignos' + citas.id + '" class="d-inline">' +   
                    
                    
                   (citas.estatus == 'Programada'  || citas.estatus == 'Reprogramada'  ? '<button type="button" class=" btn btn-dark " onclick="iniciarConsulta(' + citas.id + ');"  data-bs-toggle="modal" data-bs-target="#nuevaConsultaModal"> <i class="bi bi-heart-pulse"></i>  </button> ' : '') +
                    
                    '</div> </td>' +
                    '</tr>';
        });
        $('#tablaCitas > tbody').html(body);
    }

    //funcion para poner los combos de los estado de las citas
    function comboEstatusCitas(citas) {
        var combo = '<select class="form-select" onchange="cambiarEstatus(' + citas.id + ',this.value, this);" id="comboEstatusCita' + citas.id + '">'
        $.each(citas.estatusCita, function (i, ecita) {
            combo += '<option value="' + ecita + '" ' + (citas.estatus == ecita ? 'selected' : '') + ' >' + ecita + '</option>';
        });
        combo += '</select>';
        return combo;
    }

    // Cambiar estatus
    function cambiarEstatus(idCita, nuevoEstatus, elemento) {
        var datos = {
            id: idCita,
            estatus: nuevoEstatus
        };

        $.ajax({
            url: backend + "/citasSJLF/cambiarEstatusSJLF",
            type: 'post',
            datatype: 'json',
            data: JSON.stringify(datos),
            contentType: 'application/json',
            xhrFields: { withCredentials: true },

            success: function (respuesta) {
                if(nuevoEstatus == 'Programada' || nuevoEstatus=='Reprogramada') $ ("#divBotonSignos" + idCita).html('<button type="button" class=" btn btn-dark " onclick="iniciarConsulta(' + idCita + ');"  data-bs-toggle="modal" data-bs-target="#nuevaConsultaModal"> <i class="bi bi-heart-pulse"></i>  </button> ') ;
                else $("#divBotonSignos" + idCita).empty();

                $(elemento).removeClass("is-invalid");

                $.gritter.add({
                    title: "¡Listo!",
                    text: respuesta,
                    sticky: false,
                    image: 'correcto.png'
                });

                setTimeout(function () {
                    $(elemento).addClass("is-valid");
                }, 100);

                setTimeout(function () {
                    $(elemento).removeClass("is-valid");
                }, 1000);
            },

            error: function () {
                $(elemento).addClass("is-invalid");
            }
        });
    }

    //cambiar fecha
    function cambiarFecha(idCita, nuevaFecha, elemento) {

        if (nuevaFecha != '') {

            var donde = "#alertaCitas" + idCita;
            var datos = {
                id: idCita,
                nuevaFechaSJLF: nuevaFecha
            }
            $.ajax({
                url: backend + "/citasSJLF/cambiarFechaSJLF ",
                type: 'post',
                datatype: 'json',
                data: JSON.stringify(datos),
                contentType: 'application/json',
                xhrFields: { withCredentials: true },

                success: function (respuesta) {

                    $(elemento).removeClass("is-invalid");

                    $.gritter.add({
                        title: "¡Listo!",
                        text: respuesta,
                        sticky: false,
                        image: 'correcto.png'
                    });

                    setTimeout(function () {
                        $(elemento).addClass("is-valid");
                    }, 100);

                    setTimeout(function () {
                        $(elemento).removeClass("is-valid");
                    }, 1000);
                },

                error: function () {
                    $(elemento).addClass("is-invalid");
                }


            });
        } else {
            $(elemento).addClass("is-invalid");
        }
    }

    //iniciar Consulta
    function iniciarConsulta(idCita) {
        $("#divNuevaConsulta").load("consulta/concita.html", function () {
            cargarCita(idCita);
        });
    }

    //eliminarCita
    function eliminarCita(idCita) {
        var datos = {
            id: idCita
        }

        $.ajax({
            url: backend + "/citasSJLF/eliminarSJLF",
            type: 'post',
            datatype: 'json',
            data: JSON.stringify(datos),
            contentType: 'application/json',
            xhrFields: { withCredentials: true },



            success: function (respuesta) {

                if (respuesta == '¡Se eliminó la cita exitosamente!') {
                    $.gritter.add({
                        title: "¡Listo!",
                        text: respuesta,
                        sticky: false,
                        image: 'correcto.png'
                    });

                    $("#divPrincipal").load("citas/citas.html");


                } else {

                    $.gritter.add({
                        title: "¡Ups, Error!",
                        text: respuesta,
                        sticky: false,
                        image: 'cancelar.png'
                    })
                }

            }

        });
    }

    //modificar cita
    function modificarCita(idCita) {
        $("#divModificarCita").load('citas/modificar.html', function () {
            buscarCita(idCita);
        });
    }

    //buscar cita
    function buscarCita(idCita) {
        var datos = idCita;

        $.ajax({
            url: backend + "/citasSJLF/cargarCitaSJLF",
            type: 'post',
            datatype: 'json',
            data: JSON.stringify(datos),
            contentType: 'application/json',
            xhrFields: { withCredentials: true },

            success: function (respuesta) {
                buscarPacienteMod(respuesta.paciente.id, respuesta.id);
                buscarMedicoMod(respuesta.medico.id, respuesta.id);
            }
        });
    }

    //cargar pacientes
    function buscarPacienteMod(idPaciente, idCita) {
        $.ajax({
            url: backend + "/pacientesSJLF/listarSJLF",
            type: 'post',
            datatype: 'json',
            xhrFields: { withCredentials: true },
            success: function (respuesta) {
                comboPacienteMod(respuesta, idPaciente, idCita);
            }
        });
    }

    //cargar medicos
    function buscarMedicoMod(iDMedico, idCita) {
        $.ajax({
            url: backend + "/medicosSJLF/listarSJLF",
            type: 'post',
            datatype: 'json',
            xhrFields: { withCredentials: true },
            success: function (respuesta) {
                comboMedicosMod(respuesta, iDMedico, idCita);
            }
        });
    }


    //combo pacientes
    function comboPacienteMod(lista, idPaciente, idCita) {
        var combo = '<select class="form-select" id="comboPaciente"  onchange="actualizarPaciente(this.value, ' + idCita + ');">'
        $.each(lista, function (i, paciente) {
            combo += '<option ' + ((paciente.id == idPaciente) ? 'selected' : 'value= "' + paciente.id + '"') + '>' + paciente.nombreSJLF + '( ' + paciente.curpSJLF + ')' + '</option>';
        });
        combo += '</select>';
        $("#divPacienteCombo").html(combo);
    }

    //combo medicos
    function comboMedicosMod(lista, idMedico, idCita) {
        var combo = '<select class="form-select" id="comboMedico" onchange="actualizarMedico(this.value, ' + idCita + ');" >'
        $.each(lista, function (i, medico) {
            combo += '<option ' + ((medico.id == idMedico) ? 'selected' : 'value= "' + medico.id + '"') + ' >' + medico.nombreSJLF + ' ' + medico.apellidosSJLF + '</option>';
        });
        combo += '</select>';
        $("#divMedicoCombo").html(combo);
    }


    //actualizar pacientes
    function actualizarPaciente(idPaciente, idCita) {
        var datos = {
            id: idCita,
            paciente: {
                id: idPaciente
            }
        }
        $.ajax({
            url: backend + "/citasSJLF/modificarPacienteSJLF",
            type: 'post',
            datatype: 'json',
            data: JSON.stringify(datos),
            contentType: 'application/json',
            xhrFields: { withCredentials: true },
            success: function (respuesta) {
                if (respuesta == '¡Paciente actualizado correctamente!') {
                    $.gritter.add({
                        title: "¡Listo!",
                        text: respuesta,
                        sticky: false,
                        image: 'correcto.png'
                    });

                } else {
                    $.gritter.add({
                        title: "¡Ups, Error!",
                        text: respuesta,
                        sticky: false,
                        image: 'cancelar.png'
                    })
                }
            }
        });
    }

    //actualizar medico
    function actualizarMedico(idMedico, idCita) {
        var datos = {
            id: idCita,
            medico: {
                id: idMedico
            }
        }
        $.ajax({
            url: backend + "/citasSJLF/modificarMedicoSJLF",
            type: 'post',
            datatype: 'json',
            data: JSON.stringify(datos),
            contentType: 'application/json',
            xhrFields: { withCredentials: true },

            success: function (respuesta) {
                if (respuesta == '¡Médico actulizado correctamente!') {
                    $.gritter.add({
                        title: "¡Listo!",
                        text: respuesta,
                        sticky: false,
                        image: 'correcto.png'
                    });
                } else {
                    $.gritter.add({
                        title: "¡Ups, Error!",
                        text: respuesta,
                        sticky: false,
                        image: 'cancelar.png'
                    })
                }

            }
        });
    }


</script>


<!-- label de bienvenida -->
<div class="row">
    <div class="col m-5 text-dark">
        <h1 class="fw-bold text-center text-uppercase text-dark ">Hola, bienvenido a tu
            gestor de citas</h1>
    </div>
</div>

<!-- tabla de citas -->

<table class="table table-hover " id="tablaCitas">
    <thead class=" align-items-center">
        <tr class="table-dark ">
            <th scope="col" class="align-middle">Paciente / Médico</th>
            <th scope="col" class="align-middle">Estatus</th>
            <th scope="col" class="align-middle ">Fecha</th>

            <th scope="col" class="align-middle">

                <button type="button" data-bs-toggle="modal" data-bs-target="#nuevaCitaModal"
                    onclick=' $("#divNuevaCita").load("citas/nueva.html");' class="btn btn-outline-success  d-inline">Agendar cita <i class="bi bi-plus-circle"></i> </button>

                <button type="button" data-bs-toggle="modal" data-bs-target="#consultaSinCitaModal"
                    onclick=' $("#divConsultaSinCita").load("consulta/sincita.html");' class="btn btn-outline-light d-inline">Consulta sin cita <i class="bi bi-plus-circle"></i> </button>


            </th>

        </tr>
    </thead>
    <tbody>
    </tbody>
</table>


<!-- Modal nueva cita -->
<div class="modal fade" id="nuevaCitaModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Nueva cita</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="divNuevaCita">
                ...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarCita();">Agendar cita</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal tomar signos-->
<div class="modal fade" id="nuevaConsultaModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Toma de signos</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="divNuevaConsulta">
                ...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary" onclick="crearConsulta();">Guardar signos </button>
            </div>
        </div>
    </div>
</div>


<!-- Modal modificar cita-->
<div class="modal fade" id="modificarCitaModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header pb-0">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Modificar cita</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-0 " id="divModificarCita">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ligth" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" onclick="$('#divPrincipal').load('citas/citas.html') " class="btn btn-primary"
                    data-bs-dismiss="modal">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal consulta sin cita-->
<div class="modal fade" id="consultaSinCitaModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header pb-0">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Consulta sin cita</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-0 " id="divConsultaSinCita">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="crearConsultaSinCita();" >Crear consulta</button>
            </div>
         </div>
    </div>
</div>